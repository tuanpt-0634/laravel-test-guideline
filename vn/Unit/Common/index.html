
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.6">
    
    
      
        <title>Common Testing Rules - PHP Testing Guidelines</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6910b76c.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.196e0c26.min.css">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#common-testing-rules" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../../.." title="PHP Testing Guidelines" class="md-header-nav__button md-logo" aria-label="PHP Testing Guidelines">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            PHP Testing Guidelines
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Common Testing Rules
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="PHP Testing Guidelines" class="md-nav__button md-logo" aria-label="PHP Testing Guidelines">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    PHP Testing Guidelines
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." class="md-nav__link">
      Giới thiệu
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../01-why/" class="md-nav__link">
      Viết test để làm gì?
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../02-testcase/" class="md-nav__link">
      Cơ bản về test case
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../03-phpunit/" class="md-nav__link">
      PHPUnit
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../04-code-coverage/" class="md-nav__link">
      Code Coverage
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../05-test-doubles-and-di/" class="md-nav__link">
      Test Doubles và DI
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../06-mutation-testing/" class="md-nav__link">
      Mutation Testing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../07-laravel/" class="md-nav__link">
      Laravel
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../08-checklist/" class="md-nav__link">
      Checklist
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../09-references/" class="md-nav__link">
      Tài liệu khác
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11" >
    <label class="md-nav__link" for="nav-11">
      En
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="En" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        <span class="md-nav__icon md-icon"></span>
        En
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../en/Conventions/" class="md-nav__link">
      Laravel Testing Conventions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../en/Introduction/" class="md-nav__link">
      Introduction to Laravel Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../en/Knowledge/" class="md-nav__link">
      Knowledge about Unit Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-11-4" type="checkbox" id="nav-11-4" >
    <label class="md-nav__link" for="nav-11-4">
      Integration
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Integration" data-md-level="2">
      <label class="md-nav__title" for="nav-11-4">
        <span class="md-nav__icon md-icon"></span>
        Integration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../en/Integration/Integration/" class="md-nav__link">
      Integration Tests
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-11-5" type="checkbox" id="nav-11-5" >
    <label class="md-nav__link" for="nav-11-5">
      Unit
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Unit" data-md-level="2">
      <label class="md-nav__title" for="nav-11-5">
        <span class="md-nav__icon md-icon"></span>
        Unit
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../en/Unit/Common/" class="md-nav__link">
      Common Testing Rules
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../en/Unit/Controllers/" class="md-nav__link">
      Testing Controllers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../en/Unit/Middleware/" class="md-nav__link">
      Testing Middleware Classes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../en/Unit/Models/" class="md-nav__link">
      Testing Models
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../en/Unit/Transformers/" class="md-nav__link">
      Testing Transformers and Presenters
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../en/Unit/Validation/" class="md-nav__link">
      Testing Validation Rules.
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12" checked>
    <label class="md-nav__link" for="nav-12">
      Vn
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Vn" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        <span class="md-nav__icon md-icon"></span>
        Vn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../Conventions/" class="md-nav__link">
      Laravel Testing Conventions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Introduction/" class="md-nav__link">
      Giới thiệu về Laravel Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Knowledge/" class="md-nav__link">
      Knowledge about Unit Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-12-4" type="checkbox" id="nav-12-4" >
    <label class="md-nav__link" for="nav-12-4">
      Integration
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Integration" data-md-level="2">
      <label class="md-nav__title" for="nav-12-4">
        <span class="md-nav__icon md-icon"></span>
        Integration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../Integration/Integration/" class="md-nav__link">
      Integration Tests
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="nav-12-5" type="checkbox" id="nav-12-5" checked>
    <label class="md-nav__link" for="nav-12-5">
      Unit
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Unit" data-md-level="2">
      <label class="md-nav__title" for="nav-12-5">
        <span class="md-nav__icon md-icon"></span>
        Unit
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Common Testing Rules
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Common Testing Rules
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mocking-di-instances" class="md-nav__link">
    Mocking DI instances
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-database-queries" class="md-nav__link">
    Testing Database Queries
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Controllers/" class="md-nav__link">
      Testing Controllers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Middleware/" class="md-nav__link">
      Testing Middleware Classes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Models/" class="md-nav__link">
      Testing Models
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Transformers/" class="md-nav__link">
      Testing Transformers and Presenters
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Validation/" class="md-nav__link">
      Testing Validation Rules.
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mocking-di-instances" class="md-nav__link">
    Mocking DI instances
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-database-queries" class="md-nav__link">
    Testing Database Queries
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="common-testing-rules">Common Testing Rules<a class="headerlink" href="#common-testing-rules" title="Permanent link">&para;</a></h1>
<p>Với những thành phần như Events, Event Listeners, Subscribers, Queue Jobs và Validation Rule Classes, bạn nên tuân theo một số quy tắc cơ bản sau:</p>
<ol>
<li>Test <code>__construct()</code> method để chắc chắn rằng các properties đều được assigned.</li>
<li>Cover tất cả các public methods với những tests cần thiết.</li>
<li>Thật chú ý vào <strong>main method</strong> của class (e. g. <code>handle</code> đối với Listeners hoặc <code>passes</code> với rules).</li>
<li>Coverage là không cần thiết đối với những methods mà trả về text (ví dụ như <code>message</code> đối với rules).</li>
<li>Coverage là không bắt buộc đối với những hàm get/set cơ bản, hàm mà không chỉnh sửa tham số input.</li>
</ol>
<h2 id="mocking-di-instances">Mocking DI instances<a class="headerlink" href="#mocking-di-instances" title="Permanent link">&para;</a></h2>
<p>Laravel sử dụng injection trong rất nhiều trường hợp và components của bạn có thể sử dụng nó thông qua method/constructor injection hoặc trực tiếp trong methods thông qua container instance hoặc Facades.</p>
<p>Trong những trường hợp như vậy, sẽ là rất quan trọng để tạo Test Doubles cho từng injected instance và chắc chắn rằng không có instances nào khác được resolved.</p>
<p>Mặc định thì <code>TestCase</code> class được cung cấp với một application instance được khởi tạo sẵn bởi Laravel. Mọi thứ là tốt nếu bạn sử dụng cách tiếp cận này, tuy nhiên nên có thêm một class test case cơ bản với instance application được mock.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%; margin: 0;"><span></span><code><span style="color: #2838b0">class</span> <span style="color: #287088">MockApplicationTestCase</span> <span style="color: #2838b0">extends</span> TestCase
<span style="color: #888888">{</span>
    <span style="color: #b85820; font-style: italic">/**</span>
<span style="color: #b85820; font-style: italic">     * Creates the application.</span>
<span style="color: #b85820; font-style: italic">     *</span>
<span style="color: #b85820; font-style: italic">     * @return \Illuminate\Foundation\Application|\Mockery\Mock</span>
<span style="color: #b85820; font-style: italic">     */</span>
    <span style="color: #2838b0">public</span> <span style="color: #2838b0">function</span> <span style="color: #785840">createApplication</span><span style="color: #888888">()</span>
    <span style="color: #888888">{</span>
        <span style="color: #2838b0">return</span> m<span style="color: #666666">::</span><span style="color: #388038">mock</span><span style="color: #888888">(</span>\Illuminate\Foundation\Application<span style="color: #666666">::</span><span style="color: #388038">class</span><span style="color: #888888">)</span><span style="color: #666666">-&gt;</span><span style="color: #388038">makePartial</span><span style="color: #888888">();</span>
    <span style="color: #888888">}</span>
<span style="color: #888888">}</span>
</code></pre></div>
<p>Cách tiếp cận này sẽ giúp bạn kiểm soát tất cả các quá trình Dependecies Injection một cách cẩn thận. Và giờ bạn có thể inject Test Doubles một cách đơn giản.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%; margin: 0;"><span></span><code><span style="color: #2838b0">public</span> <span style="color: #2838b0">function</span> <span style="color: #785840">test_it_assignes_event_handler</span><span style="color: #888888">()</span>
<span style="color: #888888">{</span>
    <span style="color: #b04040">$e</span> <span style="color: #666666">=</span> m<span style="color: #666666">::</span><span style="color: #388038">mock</span><span style="color: #888888">(</span>Dispatcher<span style="color: #666666">::</span><span style="color: #388038">class</span><span style="color: #888888">);</span>
    <span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">app</span><span style="color: #666666">-&gt;</span><span style="color: #388038">bind</span><span style="color: #888888">(</span>Dispatcher<span style="color: #666666">::</span><span style="color: #388038">class</span><span style="color: #888888">,</span> <span style="color: #b04040">$e</span><span style="color: #888888">);</span>
    <span style="color: #888888; font-style: italic">// Test event assignment with mocked class.</span>
<span style="color: #888888">}</span>
</code></pre></div>
<h2 id="testing-database-queries">Testing Database Queries<a class="headerlink" href="#testing-database-queries" title="Permanent link">&para;</a></h2>
<p>Tính cô lập là rất quan trọng cho test cases, và việc chắc chắn rằng SQL queries được sinh ra chính xác là cực kỳ cần thiết.</p>
<p>Tất cả các thao tác với Database trong Laravel đều được thực hiện thông qua class <code>Illuminate\Database\Connection</code>, và các methods của nó thì dễ dàng được mock bằng cách sử dụng Mockery package.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%; margin: 0;"><span></span><code><span style="color: #b04040">$connection</span> <span style="color: #666666">=</span> m<span style="color: #666666">::</span><span style="color: #388038">mock</span><span style="color: #888888">(</span>Connection<span style="color: #666666">::</span><span style="color: #388038">class</span><span style="color: #888888">);</span>
<span style="color: #b04040">$query</span> <span style="color: #666666">=</span> <span style="color: #2838b0">new</span> Builder<span style="color: #888888">(</span><span style="color: #b04040">$connection</span><span style="color: #888888">,</span> <span style="color: #2838b0">new</span> SQLiteGrammar<span style="color: #888888">(),</span> <span style="color: #2838b0">new</span> Processor<span style="color: #888888">());</span>
<span style="color: #888888; font-style: italic">// DB::table is the most common call and it is simpler to mock the method manually instead of dealing with partial mocks.</span>
<span style="color: #b04040">$connection</span><span style="color: #666666">-&gt;</span><span style="color: #388038">allows</span><span style="color: #888888">()</span><span style="color: #666666">-&gt;</span><span style="color: #388038">table</span><span style="color: #888888">()</span><span style="color: #666666">-&gt;</span><span style="color: #388038">andReturnUsing</span><span style="color: #888888">(</span><span style="color: #2838b0">function</span> <span style="color: #888888">(</span><span style="color: #b04040">$table</span><span style="color: #888888">)</span> <span style="color: #2838b0">use</span> <span style="color: #888888">(</span><span style="color: #b04040">$query</span><span style="color: #888888">)</span> <span style="color: #888888">{</span>
    <span style="color: #2838b0">return</span> <span style="color: #b04040">$query</span><span style="color: #666666">-&gt;</span><span style="color: #388038">from</span><span style="color: #888888">(</span><span style="color: #b04040">$table</span><span style="color: #888888">);</span>
<span style="color: #888888">})</span>

<span style="color: #888888; font-style: italic">// Test your queries</span>

<span style="color: #b04040">$connection</span><span style="color: #666666">-&gt;</span><span style="color: #388038">shouldReceive</span><span style="color: #888888">(</span><span style="color: #b83838">&#39;select&#39;</span><span style="color: #888888">)</span><span style="color: #666666">-&gt;</span><span style="color: #388038">with</span><span style="color: #888888">(</span>
    <span style="color: #b83838">&#39;select * from &quot;streets&quot; limit 10 offset 0&#39;</span><span style="color: #888888">,</span> <span style="color: #888888; font-style: italic">// query</span>
    <span style="color: #888888">[],</span> <span style="color: #888888; font-style: italic">// bindings</span>
    m<span style="color: #666666">::</span><span style="color: #388038">any</span><span style="color: #888888">()</span> <span style="color: #888888; font-style: italic">// useReadPdo. use true/false if necessary</span>
<span style="color: #888888">)</span><span style="color: #666666">-&gt;</span><span style="color: #388038">andReturn</span><span style="color: #888888">([</span>
    <span style="color: #888888; font-style: italic">// &#39;query result&#39;</span>
<span style="color: #888888">]);</span>

<span style="color: #b04040">$someClass</span><span style="color: #666666">-&gt;</span><span style="color: #388038">methodUsingConnection</span><span style="color: #888888">();</span>
</code></pre></div>
<p>Đôi khi, sẽ là rất tiện lợi khi ta inject một Connection đã được mock vào trong DI để có thể sử dụng nó ở mọi nơi.
Ở đây ta trực tiếp thay đổi property, bởi sự mở rộng mặc định thì yêu cầu mock connection methods, thứ mà chúng ta không cần.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%; margin: 0;"><span></span><code><span style="color: #2838b0">public</span> <span style="color: #2838b0">function</span> <span style="color: #785840">setUp</span><span style="color: #888888">()</span>
<span style="color: #888888">{</span>
    <span style="color: #b04040">$connection</span> <span style="color: #666666">=</span> m<span style="color: #666666">::</span><span style="color: #388038">mock</span><span style="color: #888888">(</span>Connection<span style="color: #666666">::</span><span style="color: #388038">class</span><span style="color: #888888">);</span>
    <span style="color: #888888; font-style: italic">// Replace SQLiteGrammar and Processor if necessary.</span>
    <span style="color: #b04040">$query</span> <span style="color: #666666">=</span> <span style="color: #2838b0">new</span> Builder<span style="color: #888888">(</span><span style="color: #b04040">$connection</span><span style="color: #888888">,</span> <span style="color: #2838b0">new</span> SQLiteGrammar<span style="color: #888888">(),</span> <span style="color: #2838b0">new</span> Processor<span style="color: #888888">());</span>
    <span style="color: #b04040">$connection</span><span style="color: #666666">-&gt;</span><span style="color: #388038">allows</span><span style="color: #888888">()</span><span style="color: #666666">-&gt;</span><span style="color: #388038">table</span><span style="color: #888888">()</span><span style="color: #666666">-&gt;</span><span style="color: #388038">andReturnUsing</span><span style="color: #888888">(</span><span style="color: #2838b0">function</span> <span style="color: #888888">(</span><span style="color: #b04040">$table</span><span style="color: #888888">)</span> <span style="color: #2838b0">use</span> <span style="color: #888888">(</span><span style="color: #b04040">$query</span><span style="color: #888888">)</span> <span style="color: #888888">{</span>
        <span style="color: #2838b0">return</span> <span style="color: #b04040">$query</span><span style="color: #666666">-&gt;</span><span style="color: #388038">from</span><span style="color: #888888">(</span><span style="color: #b04040">$table</span><span style="color: #888888">);</span>
    <span style="color: #888888">})</span>

    <span style="color: #888888; font-style: italic">// Replace current default connection (if necessary)</span>
    <span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">afterApplicationCreated</span><span style="color: #888888">(</span><span style="color: #2838b0">function</span> <span style="color: #888888">()</span> <span style="color: #2838b0">use</span> <span style="color: #888888">(</span><span style="color: #b04040">$connection</span><span style="color: #888888">)</span> <span style="color: #888888">{</span>
        <span style="color: #b04040">$manager</span> <span style="color: #666666">=</span> <span style="color: #b04040">$app</span><span style="color: #888888">[</span><span style="color: #b83838">&#39;db&#39;</span><span style="color: #888888">];</span>
        <span style="color: #b04040">$name</span> <span style="color: #666666">=</span> <span style="color: #b04040">$manager</span><span style="color: #666666">-&gt;</span><span style="color: #388038">getDefaultConnection</span><span style="color: #888888">();</span>
        <span style="color: #b04040">$manager</span><span style="color: #666666">-&gt;</span><span style="color: #388038">purge</span><span style="color: #888888">(</span><span style="color: #b04040">$name</span><span style="color: #888888">);</span>

        <span style="color: #b04040">$r</span> <span style="color: #666666">=</span> <span style="color: #2838b0">new</span> ReflectionClass<span style="color: #888888">(</span><span style="color: #b04040">$manager</span><span style="color: #888888">);</span>
        <span style="color: #b04040">$p</span> <span style="color: #666666">=</span> <span style="color: #b04040">$r</span><span style="color: #666666">-&gt;</span><span style="color: #388038">getProperty</span><span style="color: #888888">(</span><span style="color: #b83838">&#39;connections&#39;</span><span style="color: #888888">);</span>
        <span style="color: #b04040">$p</span><span style="color: #666666">-&gt;</span><span style="color: #388038">setAccessible</span><span style="color: #888888">(</span><span style="color: #2838b0">true</span><span style="color: #888888">);</span>
        <span style="color: #b04040">$p</span><span style="color: #666666">-&gt;</span><span style="color: #388038">setValue</span><span style="color: #888888">(</span><span style="color: #b04040">$manager</span><span style="color: #888888">,</span> <span style="color: #888888">[</span>
            <span style="color: #b04040">$name</span> <span style="color: #666666">=&gt;</span> <span style="color: #b04040">$connection</span><span style="color: #888888">,</span>
        <span style="color: #888888">])</span>
    <span style="color: #888888">});</span>

    <span style="color: #888888; font-style: italic">// Assign a separate &quot;mock&quot; connection</span>
    <span style="color: #b04040">$this</span><span style="color: #666666">-&gt;</span><span style="color: #388038">afterApplicationCreated</span><span style="color: #888888">(</span><span style="color: #2838b0">function</span> <span style="color: #888888">()</span> <span style="color: #2838b0">use</span> <span style="color: #888888">(</span><span style="color: #b04040">$connection</span><span style="color: #888888">)</span> <span style="color: #888888">{</span>
        <span style="color: #b04040">$manager</span> <span style="color: #666666">=</span> <span style="color: #b04040">$app</span><span style="color: #888888">[</span><span style="color: #b83838">&#39;db&#39;</span><span style="color: #888888">];</span>
        <span style="color: #b04040">$manager</span><span style="color: #666666">-&gt;</span><span style="color: #388038">setDefaultConnection</span><span style="color: #888888">(</span><span style="color: #b83838">&#39;mock&#39;</span><span style="color: #888888">);</span>

        <span style="color: #b04040">$r</span> <span style="color: #666666">=</span> <span style="color: #2838b0">new</span> ReflectionClass<span style="color: #888888">(</span><span style="color: #b04040">$manager</span><span style="color: #888888">);</span>
        <span style="color: #b04040">$p</span> <span style="color: #666666">=</span> <span style="color: #b04040">$r</span><span style="color: #666666">-&gt;</span><span style="color: #388038">getProperty</span><span style="color: #888888">(</span><span style="color: #b83838">&#39;connections&#39;</span><span style="color: #888888">);</span>
        <span style="color: #b04040">$p</span><span style="color: #666666">-&gt;</span><span style="color: #388038">setAccessible</span><span style="color: #888888">(</span><span style="color: #2838b0">true</span><span style="color: #888888">);</span>
        <span style="color: #b04040">$list</span> <span style="color: #666666">=</span> <span style="color: #b04040">$p</span><span style="color: #666666">-&gt;</span><span style="color: #388038">getValue</span><span style="color: #888888">(</span><span style="color: #b04040">$manager</span><span style="color: #888888">);</span>
        <span style="color: #b04040">$list</span><span style="color: #888888">[</span><span style="color: #b83838">&#39;mock&#39;</span><span style="color: #888888">]</span> <span style="color: #666666">=</span> <span style="color: #b04040">$connection</span><span style="color: #888888">;</span>
        <span style="color: #b04040">$p</span><span style="color: #666666">-&gt;</span><span style="color: #388038">setValue</span><span style="color: #888888">(</span><span style="color: #b04040">$manager</span><span style="color: #888888">,</span> <span style="color: #b04040">$list</span><span style="color: #888888">);</span>
    <span style="color: #888888">});</span>


    <span style="color: #2838b0">parent</span><span style="color: #666666">::</span><span style="color: #388038">setUp</span><span style="color: #888888">();</span>
<span style="color: #888888">}</span>
</code></pre></div>
<p>Bạn cần phải nhớ tuân theo những thứ sau khi thực hiện database testing
- Bạn có thể có connection có tên (named connection), hãy cẩn thận với nó.
- Models lấy ra connections thông qua <code>ConnectionResolverInterface</code>, thứ được tự gán vào trong model và có thể khác biệt.
- Queries được tạo ra khác nhau với những cú pháp khác nhau (db khác nhau). Hãy sử dụng cái thích hợp cho project của bạn.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../../Integration/Integration/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Integration Tests
              </div>
            </div>
          </a>
        
        
          <a href="../Controllers/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Testing Controllers
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/vendor.fd16492e.min.js"></script>
      <script src="../../../assets/javascripts/bundle.7836ba4d.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../../..",
          features: [],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>